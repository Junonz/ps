window.Powershop=window.Powershop||{},Powershop.Controller=function(){var e=this,r="/prospects/",a=new Powershop.Prospect,n=new Powershop.ViewEngine(a,e),t=function(e,r){n.renderError(),console.error(r)},o=function(e){a.update(e),n.render(),n.loaded()},i=function(e){n.loading(),$.ajax({url:r+a.id(),method:"PUT",data:{prospect:e}}).done(o).fail(t)};e.createProspect=function(){var e=$.ajax({url:r}),a=e.then(function(e){return $.ajax({url:r,method:"POST",headers:{"X-CSRF-Token":e.csrf_token}})});a.done(o).fail(t)},e.refineSelection=function(){a.refineSelection=!0,n.render()},e.showPriceBreakdown=function(){a.showPriceBreakdown=!0,n.render(),n.scrollToPriceBreakdown()},e.updateDetails=function(e,r){n.scrollToPriceCharge(),a.tariff=e,null===r?n.render():i({industry_plan_id:r})},e.selectNetworkArea=function(e){i({selected_network_area_id:e,primary_place_of_residence:!0})}},Powershop.PriceCalculator={averageDailyCharge:function(e){var r=[31,28,31,30,31,30,31,31,30,31,30,31];return weightedDailyCharges=e.reduce(function(e,a,n){return e+a*r[n]},0),weightedDailyCharges/365},averageKwhCharge:function(e,r,a){return weightedPrices=r.reduce(function(r,n,t){return r+(n-a[t])*e[t]},0),yearlyUsage=e.reduce(function(e,r){return e+r},0),weightedPrices/yearlyUsage}},Powershop.GstDecorator={decorate:function(e){var r=1.15;return e*r}},Powershop.Prospect=function(){var e=this,r={};e.tariff="standard",e.refineSelection=!1,e.showPriceBreakdown=!1,e.update=function(e){r=e},e.id=function(){return r.token},e.hasSelectedNetworkArea=function(){return void 0===r.network_areas||0===r.network_areas.size},e.selectedNetworkAreaName=function(){var e=1;return r.location[e]},e.canRefineDetails=function(){return void 0!==r.industry_plans},e.availableNetworkAreas=function(){var e=[];for(var a in r.network_areas)e.push({id:a,name:r.network_areas[a]});return e.sort(function(e,r){return e.name>r.name?1:e.name<r.name?-1:0})},e.dailyCharges=function(){return e.prices().daily.map(Powershop.GstDecorator.decorate)},e.averageDailyCharge=function(){return Powershop.PriceCalculator.averageDailyCharge(e.dailyCharges())},e.registers=function(){return r.registers},e.kwhCharges=function(r){return e.prices().kwh[r.usage_tariff_id].map(Powershop.GstDecorator.decorate)},e.kwhDiscounts=function(r){return e.prices().kwh_discount[r.usage_tariff_id].map(Powershop.GstDecorator.decorate)},e.discountedKwhCharges=function(r){return e.kwhCharges(r).map(function(a,n){return a-e.kwhDiscounts(r)[n]})},e.averageKwhCharge=function(a){var n=r.profile[a.usage_tariff_id];return Powershop.PriceCalculator.averageKwhCharge(n,e.kwhCharges(a),e.kwhDiscounts(a))},e.availableRetailers=function(){return r.industry_plans},e.retailerPlans=function(e){return r.industry_plans[e]},e.prices=function(){return r.powershop_prices?r.powershop_prices[e.tariff]:null},e.callForPriceMessage=function(){return r.call_for_price_message}},Powershop.ChargePresenter={format:function(e){var r=4,a=Math.pow(10,r);return"$"+(Math.round(e*a)/a).toFixed(4)}},Powershop.UserTariffPresenter={format:function(e,r){return"standard"===e?r?"Standard User":"standard user":r?"Low User":"low user"}},Powershop.RegisterConfigurationPresenter={format:function(e){return e.map(function(e){return e.name}).join("/")}},Powershop.ViewEngine=function(e,r){var a=this,n=[new Powershop.NetworkAreaView(e,r),new Powershop.PriceResultView(e,r),new Powershop.PriceResultCallForPricesView(e,r),new Powershop.TellUsMoreView(e,r),new Powershop.SeeYourPricesView(e,r),new Powershop.RefineDetailsView(e,r),new Powershop.PriceBreakdownView(e,r)],t=$("#error-view");a.render=function(){t.hide(),n.forEach(function(e){e.html.container.hide();for(var r in e.html)e.html[r].off();e.canRender()&&e.render()})},a.loading=function(){$("#calculator").addClass("loading on"),$("#winky-loading").fadeIn()},a.loaded=function(){$(".loading").addClass("finished"),$("#winky-loading").fadeOut(),setTimeout(function(){$("#calculator").removeClass("loading on finished")},200)},a.scrollToPriceCharge=function(){$("html, body").animate({scrollTop:$("#price-result").offset().top},1e3)},a.scrollToPriceBreakdown=function(){$("html, body").animate({scrollTop:$("#price-breakdown").offset().top},1e3)},a.renderError=function(){n.forEach(function(e){e.html.container.hide()}),a.loaded(),t.show()}},Powershop.NetworkAreaView=function(e,r){var a=this;a.html={container:$("#network-area"),availableNetworkAreas:$("#available-network-areas"),form:$("#available-network-areas-form")},a.canRender=function(){return!e.hasSelectedNetworkArea()},a.render=function(){a.html.container.show(),a.renderAvailableNetworkAreas(),a.html.form.on("submit",function(e){e.preventDefault(),r.selectNetworkArea(a.html.availableNetworkAreas.val())})},a.renderAvailableNetworkAreas=function(){a.html.availableNetworkAreas.empty(),e.availableNetworkAreas().forEach(function(e){a.html.availableNetworkAreas.append($("<option>",{value:e.id,text:e.name}))})}},Powershop.PriceResultCallForPricesView=function(e){var r=this;r.html={container:$("#no-price-result"),networkArea:$("#no-price-result-network-area"),registerConfiguration:$("#price-result-register-configuration"),contactForPricing:$("#contact-for-pricing-message")},r.canRender=function(){return e.hasSelectedNetworkArea()&&!!e.callForPriceMessage()},r.render=function(){r.html.container.show(),r.html.networkArea.text(e.selectedNetworkAreaName()),r.html.registerConfiguration.text(Powershop.RegisterConfigurationPresenter.format(e.registers())),r.html.contactForPricing.text(e.callForPriceMessage())}},Powershop.PriceResultView=function(e,r){var a=this;a.html={container:$("#price-result"),dailyCharge:$("#daily-charge"),kwhCharge:$("#kwh-charge"),networkArea:$("#price-result-network-area"),userTariff:$("#price-result-user-tariff"),showPriceBreakdown:$("#over-year-info"),registerConfiguration:$("#price-result-register-configuration")},a.canRender=function(){return e.hasSelectedNetworkArea()&&!e.callForPriceMessage()},a.render=function(){a.html.container.show(),a.renderDailyCharge(),a.renderKwhCharge(),a.html.networkArea.text(e.selectedNetworkAreaName()),a.html.userTariff.text(Powershop.UserTariffPresenter.format(e.tariff)),a.html.registerConfiguration.text(Powershop.RegisterConfigurationPresenter.format(e.registers())),a.html.showPriceBreakdown.on("click",function(e){e.preventDefault(),r.showPriceBreakdown()})},a.renderDailyCharge=function(){a.html.dailyCharge.text(Powershop.ChargePresenter.format(e.averageDailyCharge()))},a.renderKwhCharge=function(){a.html.kwhCharge.empty(),e.registers().forEach(function(r){var n=$("<tr>");n.append($("<th>",{text:r.name+" ($/kWh)"})),n.append($("<td>",{text:Powershop.ChargePresenter.format(e.averageKwhCharge(r))})),a.html.kwhCharge.append(n)})}},Powershop.TellUsMoreView=function(e,r){var a=this;a.html={container:$("#tell-us-more"),refineSelection:$("#show-refine-selection")},a.canRender=function(){return e.hasSelectedNetworkArea()&&e.canRefineDetails()&&!e.refineSelection&&!e.callForPriceMessage()},a.render=function(){a.html.container.show(),a.html.refineSelection.on("click",function(e){e.preventDefault(),r.refineSelection()})}},Powershop.SeeYourPricesView=function(e,r){var a=this;a.html={container:$("#see-your-prices"),showPriceBreakdown:$("#show-price-breakdown")},a.canRender=function(){return e.hasSelectedNetworkArea()&&!e.showPriceBreakdown&&!e.callForPriceMessage()},a.render=function(){a.html.container.show(),a.html.showPriceBreakdown.on("click",function(e){e.preventDefault(),r.showPriceBreakdown()})}},Powershop.RefineDetailsView=function(e,r){var a=this;a.html={container:$("#refine-details"),form:$("#refine-details-form"),availableRetailers:$("#available-retailers"),availableRetailerPlans:$("#available-retailer-plans")},a.canRender=function(){return e.hasSelectedNetworkArea()&&e.canRefineDetails()&&e.refineSelection},a.render=function(){a.html.container.fadeIn(),a.renderAvailableRetailers(),a.renderAvailableRetailerPlans(),a.html.availableRetailers.on("change",function(){a.renderAvailableRetailerPlans()}),a.html.form.on("submit",function(e){e.preventDefault(),$(".not-you").hide(),r.updateDetails($("input[name=user-type]:checked").val(),a.html.availableRetailerPlans.val())})},a.renderAvailableRetailers=function(){a.html.availableRetailers.empty(),a.html.availableRetailers.append($("<option>",{value:"",selected:!0}));for(var r in e.availableRetailers())a.html.availableRetailers.append($("<option>",{value:r,text:r}))},a.renderAvailableRetailerPlans=function(){a.html.availableRetailerPlans.empty();var r=a.html.availableRetailers.val();if(r){var n=e.retailerPlans(r);for(var t in n)a.html.availableRetailerPlans.append($("<option>",{value:t,text:n[t]}))}}},Powershop.PriceBreakdownView=function(e){var r=this;r.html={container:$("#price-breakdown"),table:$("#price-breakdown-body"),tableHead:$("#price-breakdown-head"),tariff:$("#breakdown-user-tariff"),networkArea:$("#breakdown-network-area"),registerConfiguration:$("#breakdown-configuration")},r.canRender=function(){return e.hasSelectedNetworkArea()&&e.showPriceBreakdown},r.render=function(){r.html.container.fadeIn(),r.html.table.empty(),r.html.tableHead.empty();var a=Powershop.PriceBreakdownTableViewModel(new Date,e);r.renderMonths(a.months),r.renderDailyCharges(a.dailyCharges),r.renderKwhCharges(a.registers),r.html.networkArea.text(e.selectedNetworkAreaName()),r.html.tariff.text(Powershop.UserTariffPresenter.format(e.tariff,!0)),r.html.registerConfiguration.text(Powershop.RegisterConfigurationPresenter.format(e.registers()))},r.renderMonths=function(e){var a=$("<tr class='months white-type'>");a.append($("<th>")),a.append($("<th>")),e.forEach(function(e){a.append($("<th>",{text:e}))}),a.append($("<th>",{text:"Annual Average"})),r.html.tableHead.append(a)},r.renderDailyCharges=function(a){r.renderRow("Daily",a,e.averageDailyCharge(),"$/day")},r.renderKwhCharges=function(e){e.forEach(function(e){r.renderRow(e.name,e.charges,e.averageCharge,"$/kWh")})},r.renderRow=function(e,a,n,t){var o=$("<tr>");o.append($("<th>",{text:e})),o.append($("<td>",{text:"("+t+")"})),a.forEach(function(e){o.append($("<td>",{text:Powershop.ChargePresenter.format(e)}))}),o.append($("<td>",{text:Powershop.ChargePresenter.format(n)})),r.html.table.append(o)},Powershop.PriceBreakdownTableViewModel=function(e,r){for(var a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=r.dailyCharges(),t=r.registers().map(function(e){return{name:e.name,charges:r.discountedKwhCharges(e),averageCharge:r.averageKwhCharge(e)}}),o=0;o<e.getMonth();o++)a.push(a.shift()),n.push(n.shift()),t.forEach(function(e){e.charges.push(e.charges.shift())});return{months:a,dailyCharges:n,registers:t}}};